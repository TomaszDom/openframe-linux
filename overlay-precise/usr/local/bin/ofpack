#!/bin/bash

# ofpack v1.19 (23rd April 2014)
#  Installs and configures various additional components to a running OpenFrame.

#set -x

if [ "$USER" != "root" ]; then
  echo "Usage: $0 [emgd]"
  echo "You need to run this with superuser privileges."
  exit 0
fi


## Enable repos and pin packages if we're going with the Intel EMGD drivers.
INSTALLEMGD=""
if [[ "$1" == "emgd" ]]; then
	INSTALLEMGD=" with EMGD drivers"
	[ -f /etc/X11/xorg.conf.emgd ] && mv /etc/X11/xorg.conf.emgd /etc/X11/xorg.conf
	[ ! -f /etc/apt/preferences.d/openframe-emgd.pref ] && [ ! -f /etc/apt/preferences.d/xorg.pref ] && mv /etc/apt/preferences.d/disabled/* /etc/apt/preferences.d
	[ ! -f /etc/apt/sources.list.d/openframe-emgd.list ] && mv /etc/apt/sources.list.d/disabled/* /etc/apt/sources.list.d
	echo -e "## Disable the GMA500 kernel driver\nblacklist gma500_gfx" > /etc/modprobe.d/blacklist-gma500.conf
else
	mkdir -p /etc/apt/preferences.d/disabled 2>/dev/null
	[ -f /etc/X11/xorg.conf ] && mv /etc/X11/xorg.conf /etc/X11/xorg.conf.emgd
	[ -f /etc/apt/preferences.d/openframe-emgd.pref ] && mv /etc/apt/preferences.d/openframe-emgd.pref /etc/apt/preferences.d/disabled
	[ -f /etc/apt/preferences.d/xorg.pref ] && mv /etc/apt/preferences.d/xorg.pref /etc/apt/preferences.d/disabled
	[ -f /etc/apt/sources.list.d/openframe-emgd.list ] && mv /etc/apt/sources.list.d/openframe-emgd.list /etc/apt/sources.list.d/disabled
	rm /etc/modprobe.d/blacklist-gma500.conf 2>/dev/null
fi

echo
echo "Installing the OpenFrame Pack$INSTALLEMGD..."
echo
sleep 2
echo "Updating package lists..."
sleep 1
echo
apt-get update
echo


## Install X and EMGD.
if [[ "$INSTALLEMGD" == "" ]]; then
	# If we're using the GMA500 kernel driver...
	echo "Installing X..."
	sleep 2
	echo
	apt-get -y install xinit xterm
	echo
else
	# If we're using the Intel EMGD driver...
	echo "Installing X and EMGD drivers..."
	sleep 2
	echo
	apt-get -y install emgd-dkms xorg-emgd xinit vainfo
	echo
fi


## Install mplayer and set some nice defaults.
echo "Installing mplayer..."
sleep 2
echo
apt-get -y install mplayer
if [[ "$INSTALLEMGD" == "" ]]; then
	# If we're using the GMA500 kernel driver...
	echo -e "\n###OpenFrame Specific\nao=alsa\nva=x11\nzoom=yes\nfs=yes" >> /etc/mplayer/mplayer.conf
else
	# If we're using the Intel EMGD driver...
	echo -e "\n###OpenFrame Specific\nva=vaapi\nvo=vaapi\nfs=yes" >> /etc/mplayer/mplayer.conf
fi
echo -e "\n###OpenFrame Specific\nMOUSE_BTN0_DBL quit\nMOUSE_BTN0-MOUSE_BTN0_DBL quit" >> /etc/mplayer/input.conf
echo


# Install the wireless driver from Realtek for the RT2770F USB card used in the OpenFrame 1.
echo "Installing Realtek wireless driver..."
sleep 2
echo
apt-get -y install rt2870sta-dkms
echo


## Unmute the audio output at 50% volume to prevent unnecessary panicking about broken audio. :)
echo "Unmuting master audio output..."
sleep 2
echo
/usr/bin/amixer -c 0 sset "Master" 50% unmute
echo


## Clean everything up.
echo "Tidying..."
sleep 2
echo
apt-get -y clean
echo
depmod -a
update-initramfs -u
/usr/local/bin/ofclean auto


echo "Installation of OpenFrame Pack complete."
sync
sync
exit 0


