#!/bin/bash

# ofsetup v1.22 (3rd November 2014)
#  Installs and configures various additional components to a running OpenFrame.

#set -x

if [ "$USER" != "root" ]; then
  echo "You need to run this with superuser privileges."
  exit 1
fi

KERNELVER=`uname -r | awk -F\. {'print $2'}`

if [ $# -eq 0 ]; then
	INSTALLTYPE="basic"
	INSTALLMSG=""
	echo
elif [ "$1" = "emgd" ]; then
	[ $KERNELVER -gt 2 ] && echo;echo "WARNING: Intel's EMGD drivers will not normally compile under kernels greater than 3.2!"
	echo
	sleep 5
	INSTALLTYPE="$1"
	INSTALLMSG=" (EMGD)"
elif [ "$1" = "gma" ]; then
	INSTALLTYPE="$1"
	INSTALLMSG=" (GMA500)"
	echo
else
	echo "Usage: $0 [emgd | gma]"
	echo "Unknown installation option."
	exit 1
fi

echo "Beginning OpenFrame Setup$INSTALLMSG..."
echo
sleep 1


# Enable extra repos and pin packages if we're going with the Intel EMGD drivers.
if [[ "$INSTALLTYPE" == "emgd" ]]; then
	[ -f /etc/X11/xorg.conf.emgd ] && mv /etc/X11/xorg.conf.emgd /etc/X11/xorg.conf
	[ ! -f /etc/apt/preferences.d/openframe-emgd.pref ] && mv /etc/apt/preferences.d/disabled/openframe-emgd.pref /etc/apt/preferences.d/
	[ ! -f /etc/apt/preferences.d/xorg.pref ] && mv /etc/apt/preferences.d/disabled/xorg.pref /etc/apt/preferences.d/
	[ ! -f /etc/apt/sources.list.d/openframe-emgd.list ] && mv /etc/apt/sources.list.d/disabled/openframe-emgd.list /etc/apt/sources.list.d/
	echo -e "## Disable the GMA500 kernel driver\nblacklist gma500_gfx" > /etc/modprobe.d/blacklist-gma500.conf
else
	mkdir -p /etc/apt/preferences.d/disabled 2>/dev/null
	[ -f /etc/X11/xorg.conf.gma500 ] && mv /etc/X11/xorg.conf.gma500 /etc/X11/xorg.conf
	[ -f /etc/apt/preferences.d/openframe-emgd.pref ] && mv /etc/apt/preferences.d/openframe-emgd.pref /etc/apt/preferences.d/disabled/
	[ -f /etc/apt/preferences.d/xorg.pref ] && mv /etc/apt/preferences.d/xorg.pref /etc/apt/preferences.d/disabled/
	[ -f /etc/apt/sources.list.d/openframe-emgd.list ] && mv /etc/apt/sources.list.d/openframe-emgd.list /etc/apt/sources.list.d/disabled/
	rm /etc/modprobe.d/blacklist-gma500.conf 2>/dev/null
fi

if [[ ! "$INSTALLTYPE" == "basic" ]]; then
	echo "Updating package lists..."
	sleep 1
	echo
	apt-get update
	echo
fi


# Install the wireless driver from Realtek for the RT2770F USB card used in the OpenFrame 1 if kernel is older than 3.14.
if [ $KERNELVER -lt 14 ]; then
	echo "Installing Realtek wireless driver..."
	sleep 2
	echo
	[ ! -f /etc/apt/preferences.d/openframe-jools.pref ] && mv /etc/apt/preferences.d/disabled/openframe-jools.pref /etc/apt/preferences.d/
	[ ! -f /etc/apt/sources.list.d/openframe-jools.list ] && mv /etc/apt/sources.list.d/disabled/openframe-jools.list /etc/apt/sources.list.d/
	apt-get update
	apt-get -y install rt2870sta-dkms
	echo
fi


# Install appropriate graphics gubbins.
if [[ "$INSTALLTYPE" == "gma" ]]; then
	echo "Installing X..."
	sleep 2
	echo
	apt-get -y install xinit xterm
	echo
elif [[ "$INSTALLTYPE" == "emgd" ]]; then
	echo "Installing X and EMGD drivers..."
	sleep 2
	echo
	apt-get -y install emgd-dkms xorg-emgd xinit vainfo
	echo
fi


# Install mplayer and set some nice defaults.
if [[ ! "$INSTALLTYPE" == "basic" ]]; then
	echo "Installing mplayer..."
	sleep 2
	echo
	apt-get -y install mplayer
	if [[ "$INSTALLTYPE" == "" ]]; then
		# If we're using the GMA500 kernel driver...
		echo -e "\n###OpenFrame Specific\nao=alsa\nva=x11\nzoom=yes\nfs=yes" >> /etc/mplayer/mplayer.conf
	else
		# If we're using the Intel EMGD driver...
		echo -e "\n###OpenFrame Specific\nva=vaapi\nvo=vaapi\nfs=yes" >> /etc/mplayer/mplayer.conf
	fi
	echo -e "\n###OpenFrame Specific\nMOUSE_BTN0_DBL quit\nMOUSE_BTN0-MOUSE_BTN0_DBL quit" >> /etc/mplayer/input.conf
	echo
fi


## Unmute the audio output at 50% volume to prevent unnecessary panicking about broken audio. :)
echo "Unmuting audio output..."
echo
/usr/bin/amixer -c 0 sset "Master" 50% unmute
echo


## Clean everything up.
echo "Tidying..."
sleep 2
echo
depmod -a
update-initramfs -u
/usr/local/bin/ofclean auto


echo "OpenFrame setup complete."
sync
sync
exit 0
